<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="Description" content="Enter your description here" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/knowledge.css">
    <title>ORDER</title>
</head>

<body>
    <div class="jumbotron jumbotron-fluid pt-4 mb-0" style="background-color: #fff;">
        <div class="container-fluid p-0">
            <nav class="navbar navbar-expand-lg navbar-light bg-faded">
                <button class="navbar-toggler btn-left bg-light float-left" type="button" data-toggle="collapse" data-target="#navbarMobile" aria-controls="navbarMobile" aria-expanded="false" aria-label="Toggle navigation" id="navbarToggler">
              <span class="navbar-toggler-icon"></span>
                    </button>
                <div class="collapse navbar-collapse nav-fill w-100 ml-3" id="navbarMobile">
                    <div class="mx-auto headerLogo d-lg-none">
                        <a href="index.html" class="float-right w-100x  ">
                            <img src="images/LOGO_MATCHMINTON.png" alt="" class="w-100">
                        </a>
                    </div>
                    <!-- <div class="collapse "> -->
                    <ul class="nav navbar-nav nav-fill w-100">
                        <li class="nav-item">
                            <a class="nav-link" href="match.html">MATCHING</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="buySale.html">SHOP</a>
                        </li>
                    </ul>
                    <!-- </div> -->

                    <div class="mx-auto headerLogo d-none d-lg-block">
                        <a href="index.html" class="float-right w-100x  ">
                            <img src="images/LOGO_MATCHMINTON.png" alt="" class="w-100">
                        </a>
                    </div>

                    <!-- <div class="collapse navbar-collapse nav-fill w-100"> -->

                    <ul class="nav navbar-nav nav-fill w-100">
                        <li class="nav-item">
                            <a class="nav-link" href="webboard.html">COMMUNITY</a>
                        </li>
                        <!-- navbar ในส่วนที่ยังไม่ได้ login จะแสดง LOGIN  -->
                        <li class="nav-item" id="not-login">
                            <a class="nav-link" href="login.html">LOGIN</a>
                        </li>
                        <!-- </ul> 
                         <ul class="navbar-nav px-0"> 
                         <li class="nav-item">
                            <a href="createtheme.html"><button type="button" class="btn btn-info mx-2" data-toggle="modal" data-target="#exampleModal">ตั้งกระทู้</button></a>
                        </li> 
                         <li class="nav-item">
                            &nbsp;<a href="order.html"><i class="fas fa-shopping-cart"></i></a>
                        </li> -->
                        <!-- navbar ในส่วนที่ login  ยินดีต้อนรับ คุณ<span id="user_name"></span>  -->
                        <li class="nav-item" id="is-login">
                            <div class="dropdown">
                                <p class="dropdown-toggle mx-2" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" style="font-size: x-large; padding-top: 8px; font-weight: bold; color: #0AB2AC;">
                                    ยินดีต้อนรับ คุณ<span id="user_name"></span>
                                </p>
                                <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                                    <a class="dropdown-item" href="Editprofile.html"><i class="fas fa-cog"></i> แก้ไขโปรไฟล์</a>
                                    <a class="dropdown-item" onclick="logout()" href="#"><i class="fas fa-sign-out-alt"></i> ออกจากระบบ</a>
                                    <a class="dropdown-item" href="createtheme.html"><i class="fas fa-scroll"></i> ตั้งกระทู้</a>
                                    <a class="dropdown-item" href="order.html"><i class="fas fa-shopping-cart"></i> ตะกร้าสินค้า</a>
                                </div>
                            </div>
                        </li>
                    </ul>
                </div>
            </nav>
        </div>
    </div>
    <div class="container">
        <form action="service/insert_order.php" onsubmit="onSubmit()" method="POST" class="p-0 m-0">
            <input type="hidden" name="user_id" id="user_id" />
            <input type="hidden" name="total_price" id="total_price" />
            <input type="hidden" name="cart" id="cart" />
            <div>
                <div class="card my-0">
                    <div class="card-body">
                        <div class="form-group">
                            <label for="address_payment">
                            <h5 style="color: #0CB3AC;"><i class="fas fa-map-marker-alt"></i> ที่อยู่ในการจัดส่ง</h5>
                        </label>
                            <input type="text" name="address" class="form-control" id="address_payment" required placeholder="กรุณากรอกที่อยู่">
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body">
                        <table class="table table-borderless">
                            <thead>
                                <tr>
                                    <th>สั่งซื้อสินค้าแล้ว</th>
                                    <th class="text-center">ราคาต่อหน่วย</th>
                                    <th class="text-center">จำนวน</th>
                                    <th class="text-right">รายการย่อย</th>
                                </tr>
                                <tr>
                                    <td>จำหน่ายโดย <img src="images/LOGO_MATCHMINTON.jpg" alt="" style="width: 100px;"></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                </tr>
                            </thead>
                            <tbody id="result">



                            </tbody>
                        </table>
                        <hr>
                        <div class="row pt-3">
                            <div class="col-md-6">
                                <div class="form-group row">
                                    <label for="inputsend" class="col-sm-3 col-form-label pr-0">หมายเหตุ: </label>
                                    <div class="col-sm-9">
                                        <input type="text" name="remark" class="form-control" id="inputsend" placeholder="ไม่บังคับ (ฝากถึงผู้จัดส่ง)">
                                    </div>
                                </div>
                            </div>
                            <!-- <div class="col-md-3 text-center">
                            <h5 style="color: #0CB3AC;">Shipping Opion</h5>
                        </div> -->
                            <div class="col-md-6">
                                <div class="text-right">
                                    <h5 class="font-weight-bold">จัดส่งแบบปกติ J&T</h5>
                                    <p class="m-0 text-muted">จะได้รับสินค้าไม่เกิน 3 - 7 วัน</p>
                                </div>
                            </div>
                            <!-- <div class="col text-right">
                            <h5>฿22</h5>
                        </div> -->
                        </div>
                        <hr>
                        <!-- <div class="text-right">
                        <p>ค่าธรรมเนียม:
                            <font style="color: #0CB3AC;">฿15</font>
                        </p>
                        <h5>ยอดสั่งซื้อทั้งหมด (1 ชิ้น):
                            <font style="color: #0CB3AC;" id="total_summary"></font>
                        </h5>
                    </div> -->
                    </div>
                </div>

                <div class="card">
                    <div class="card-body">
                        <!-- <h5>วิธีการชำระเงิน</h5>
                    <div class="btn-group btn-group-toggle" data-toggle="buttons">
                        <label class="btn btn-outline-info mr-2">
                        <input type="radio" name="pay" id="pay1" > บัตรเครดิต/บัตรเดบิต
                        </label>
                        <label class="btn btn-outline-info mr-2">
                        <input type="radio" name="pay" id="pay2"> IBanking / Mobile Banking
                        </label>
                        <label class="btn btn-outline-info mr-2">
                        <input type="radio" name="pay" id="pay3"> ชำระผ่าน ATM
                        </label>
                        <label class="btn btn-outline-info mr-2">
                            <input type="radio" name="pay" id="pay4"> โอน/ชำระผ่านบัญชีธนาคาร
                        </label>
                    </div>
                    <hr> -->
                        <h5>เลือกบัญชีการชำระเงิน</h5>
                        <div class="form-check pb-2">
                            <input class="form-check-input pt-2" type="radio" name="credit_card" id="account1" value="555" checked onclick="closeCard()">
                            <label class="form-check-label" for="account1">
                        <img src="images/visa-light-large.png" alt="" width="40"> ธนาคารกรุงไทย **** 9999
                        </label>
                        </div>
                        <div class="form-check pb-2">
                            <input class="form-check-input pt-2" type="radio" name="credit_card" id="other" value="other" onclick="openCard()">
                            <label class="form-check-label" for="other">
                        อื่นๆ
                        </label>
                        </div>
                        <!-- <button type="button" class="btn btn-outline-secondary" data-toggle="modal" data-target="#choose_acc"><i class="fas fa-plus"></i> ชำระด้วยบัตรใหม่</button> -->
                        <!-- <button type="button" class="btn btn-outline-secondary" id="btn-add" onclick="openCard()"><i class="fas fa-plus"></i> ชำระด้วยบัตรใหม่</button>
                    <button type="button" class="btn btn-outline-secondary d-none" id="btn-close" onclick="closeCard()"><i class="fas fa-minus"></i> ยกเลิก</button> -->
                        <div class="d-none" id="credir-card">
                            <div class="row">
                                <div class="col-6">
                                    <div class="form-row">
                                        <div class="col-md-12 mb-3">
                                            <h5 class="modal-title" id="choose_accLabel">เพิ่มบัตรเครดิต/บัตรเดบิต</h5>
                                        </div>
                                        <div class="col-md-12 mb-3">
                                            <input type="text" class="form-control" name="card_name" value="test" placeholder="Card Name" required>
                                        </div>
                                        <div class="col-md-7 mb-3">
                                            <input type="text" class="form-control" name="card_no" value="1234567890" placeholder="Card NO" required>
                                        </div>
                                        <i class="fab fa-cc-visa mr-2" style="font-size: 40px; color:navy;"></i>
                                        <i class="fab fa-cc-jcb mr-2" style="font-size: 40px; color:#f24b;"></i>
                                        <i class="fab fa-cc-mastercard" style="font-size: 40px; color:red;"></i>

                                        <div class="form-group col-md-4">
                                            <label for="inputDate">วันที่หมดอายุ</label>
                                            <select id="inputDate" class="form-control" name="expire_month">
                                        <option selected>เดือน</option>
                                        <option value="1">01</option>
                                        <option value="2">02</option>
                                        <option value="3">03</option>
                                        <option value="4">04</option>
                                        <option value="5">05</option>
                                        <option value="6">06</option>
                                        <option value="7">07</option>
                                        <option value="8">08</option>
                                        <option value="9">10</option>
                                        <option value="11">11</option>
                                        <option value="12">12</option>
                                    </select>
                                        </div>
                                        <div class="form-group col-md-4">
                                            <!-- <label for="inputYear"> </label> -->
                                            <select id="inputYear" class="form-control" name="expire_year" style="margin-top: 2rem;">
                                        <option selected>ปี</option>
                                        <option value="2020">2020</option>
                                        <option value="2021">2021</option>
                                        <option value="2022">2022</option>
                                        <option value="2023">2023</option>
                                        <option value="2024">2024</option>
                                        <option value="2025">2025</option>
                                        <option value="2026">2026</option>
                                        <option value="2027">2027</option>
                                        <option value="2028">2028</option>
                                        <option value="2029">2029</option>
                                        <option value="2030">2030</option>
                                    </select>
                                        </div>
                                        <div class="form-group col-md-4">
                                            <label for="inputCvc">CVC</label>
                                            <input type="text" class="form-control" name="cvc_no" value="123" id="inputCvc" required>
                                        </div>

                                        <div class="col-md-12 mb-3">
                                            <input type="text" class="form-control" name="address" placeholder="ที่อยู่">
                                        </div>
                                        <div class="col">
                                            <input type="text" class="form-control" name="post" placeholder="เลขไปรษณีย์">
                                        </div>
                                    </div>
                                </div>
                                <!-- <div class="col-md-12 my-4">
                                <button type="button" class="btn btn-outline-secondary" data-dismiss="modal">ยกเลิก</button>
                                <button type="button" class="btn btn-outline-danger">ยืนยัน</button>
                            </div> -->
                            </div>
                        </div>
                        <!-- Modal -->
                        <!-- <div class="modal fade" id="choose_acc" tabindex="-1" aria-labelledby="choose_accLabel" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="choose_accLabel">เพิ่มบัตรเครดิต/บัตรเดบิต</h5>
                                
                                </div>
                                <form class="m-0">
                                    <div class="modal-body">
                                        <div class="form-row">
                                            <div class="col-md-12 mb-3">
                                                <input type="text" class="form-control" name="card_name" placeholder="Card Name" required>
                                            </div>
                                            <div class="col-md-7 mb-3">
                                                <input type="text" class="form-control" name="card_no" placeholder="Card NO" required  >
                                            </div>
                                            <i class="fab fa-cc-visa mr-2" style="font-size: 40px; color:navy;"></i>
                                            <i class="fab fa-cc-jcb mr-2" style="font-size: 40px; color:#f24b;"></i>
                                            <i class="fab fa-cc-mastercard" style="font-size: 40px; color:red;"></i>

                                            <div class="form-group col-md-4">
                                                <label for="inputDate">วันที่หมดอายุ</label>
                                                <select id="inputDate" class="form-control" name="expire_month">
                                                <option selected>เดือน</option>
                                                <option value="1">01</option>
                                                <option value="2">02</option>
                                                <option value="3">03</option>
                                                <option value="4">04</option>
                                                <option value="5">05</option>
                                                <option value="6">06</option>
                                                <option value="7">07</option>
                                                <option value="8">08</option>
                                                <option value="9">10</option>
                                                <option value="11">11</option>
                                                <option value="12">12</option>
                                            </select>
                                            </div>
                                            <div class="form-group col-md-4">
                                                <select id="inputYear" class="form-control" name="expire_year" style="margin-top: 2rem;">
                                                <option selected>ปี</option>
                                                <option value="2020">2020</option>
                                                <option value="2021">2021</option>
                                                <option value="2022">2022</option>
                                                <option value="2023">2023</option>
                                                <option value="2024">2024</option>
                                                <option value="2025">2025</option>
                                                <option value="2026">2026</option>
                                                <option value="2027">2027</option>
                                                <option value="2028">2028</option>
                                                <option value="2029">2029</option>
                                                <option value="2030">2030</option>
                                            </select>
                                            </div>
                                            <div class="form-group col-md-4">
                                                <label for="inputCvc">CVC</label>
                                                <input type="text" class="form-control" name="cvc_no" id="inputCvc" required>
                                            </div>

                                            <div class="col-md-12 mb-3">
                                                <input type="text" class="form-control" name="address" placeholder="ที่อยู่">
                                            </div>
                                            <div class="col">
                                                <input type="text" class="form-control" name="post" placeholder="เลขไปรษณีย์">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-outline-secondary" data-dismiss="modal">ยกเลิก</button>
                                        <button type="submit" class="btn btn-outline-danger">ยืนยัน</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div> -->
                        <hr>
                        <div class="row text-right">
                            <div class="col-md-10">
                                <h5>ยอดรวมสินค้า</h5>
                                <h5>ค่าจัดส่ง</h5>
                                <h5>การชำรเงินทั้งหมด</h5>
                            </div>
                            <div class="col">
                                <h5 id="product_price"></h5>
                                <h5 id="sum_shipping"></h5>
                                <h5>
                                    <font style="color: #0CB3AC;" id="total_summary"></font>
                                </h5>
                            </div>
                        </div>
                        <hr>
                        <button type="submit" class="btn btn-info float-right">สั่งซื้อสินค้า</button>
                    </div>
        </form>

        <!--<div class="modal fade" id="confirmPayment" tabindex="-1" aria-labelledby="confirmPaymentLabel" aria-hidden="true">
                     <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        จำนวนเงินที่ต้องชำระ
                                    </div>
                                    <div class="col text-right">
                                        ฿ 61
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-outline-dark " data-dismiss="modal">ยกเลิก</button>
                                <a href="orderdetail.html" class="btn btn-danger">ชำระ</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div> -->
        </div>

        </div>
        <!-- container -->

        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.1/umd/popper.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.2/js/bootstrap.min.js"></script>
        <script>
            var user = JSON.parse(localStorage.getItem('user'));
            let cart_data = JSON.parse(localStorage.getItem('cart')) ? JSON.parse(localStorage.getItem('cart')) : [];
            var products = [];
            if (user != null) {
                // alert(user.user_id);
                $('#user_name').text(user.name)
                $('#not-login').addClass('d-none')
                $('#is-login').removeClass('d-none')
                $('#user_id').val(user.user_id);

            } else {
                $('#not-login').removeClass('d-none')
                $('#is-login').addClass('d-none')
            }

            logout = () => {
                localStorage.removeItem('user')
                $('#not-login').removeClass('d-none')
                $('#is-login').addClass('d-none')
            }

            const calSum = (carts) => {
                var sum = carts.reduce((total, val) => {
                    var c = products.find(item => item.cart_id == val.cart_id) || {
                        price: 0
                    }
                    alert(val.cart_id);
                    return parseFloat(c.price * c.amount) + total
                }, 0);
                return (sum);
            }

            const onSubmit = () => {
                localStorage.removeItem('cart')
            }

            function currencyFormat(num) {
                return '฿' + num.toFixed(2).replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1,')
            }


            $().ready(() => {
                $.ajax({
                    method: "POST",
                    url: "service/cart.php",
                    data: {
                        action: 'show_order',
                    },
                }).done(function(msg) {
                    msg = JSON.parse(msg)
                    if (msg.code === 200) {
                        var res = msg.result;
                        console.log('res.product', res.product);
                        products = res.product;
                        let data = res.product.filter(item => cart_data.find(val => val.cart_id == item.cart_id));
                        console.log('products', data);
                        for (i = 0; i < data.length; i++) {
                            let image = res.product_images.find((item) => data[i].product_id == item.fk_product_id);
                            $('#result').append(Card(data[i], image));
                        };
                        if (cart_data) {
                            var total_product = calSum(cart_data);
                            var sum = total_product + Math.round(calShippng(cart_data) / 2) * 60;
                            // alert(calShippng(cart_data));
                            $('#product_price').text(currencyFormat(total_product));
                            $('#total_summary').text(currencyFormat(sum));
                            $('#total_price').val(sum);
                            $('#sum_shipping').text('฿ ' + Math.round(calShippng(cart_data) / 2) * 60)
                            $('#cart').val(JSON.stringify(cart_data));
                        }
                    }
                });
            })

            calShippng = (carts) => {
                var sum = carts.reduce((total, val) => {
                    var c = products.find(item => item.cart_id == val.cart_id) || {
                        price: 0
                    }
                    return parseInt(c.amount) + total
                }, 0);
                return (sum);
            }


            Card = (item, image) => {
                var img = image ? 'service/' + image.path : 'https://via.placeholder.com/150';
                return `
                <tr>
                    <td>
                        <div class="media">
                            <img src="${img}" class="align-self-center mr-3 border" alt="..." style="width: 50px; height: 50px;">
                            <div class="media-body py-3">
                                <p class="m-0">${item.product_name}</p>
                            </div>
                        </div>
                    </td>
                    <td class="text-center">${currencyFormat(item.price*1)}</td>
                    <td class="text-center">${item.amount}</td>
                    <td class="text-right">${currencyFormat(item.price * item.amount)}</td>
                </tr>
            `;
            };

            const openCard = () => {
                $('#btn-add').addClass('d-none')
                $('#btn-close').removeClass('d-none')
                $('#credir-card').removeClass('d-none')
            }
            const closeCard = () => {
                $('#btn-add').removeClass('d-none')
                $('#btn-close').addClass('d-none')
                $('#credir-card').addClass('d-none')
            }
        </script>
</body>

</html>